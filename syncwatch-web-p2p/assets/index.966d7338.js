(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const o of i)if(o.type==="childList")for(const m of o.addedNodes)m.tagName==="LINK"&&m.rel==="modulepreload"&&s(m)}).observe(document,{childList:!0,subtree:!0});function n(i){const o={};return i.integrity&&(o.integrity=i.integrity),i.referrerpolicy&&(o.referrerPolicy=i.referrerpolicy),i.crossorigin==="use-credentials"?o.credentials="include":i.crossorigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function s(i){if(i.ep)return;i.ep=!0;const o=n(i);fetch(i.href,o)}})();/*! simple-peer. MIT License. Feross Aboukhadijeh <https://feross.org/opensource> */const Ne=64*1024,Ze=5*1e3,et=5*1e3;function Pe(t){const e=new Uint8Array(t);for(let n=0;n<t;n++)e[n]=Math.random()*256|0;return e}function je(){if(typeof globalThis>"u")return null;const t={RTCPeerConnection:globalThis.RTCPeerConnection||globalThis.mozRTCPeerConnection||globalThis.webkitRTCPeerConnection,RTCSessionDescription:globalThis.RTCSessionDescription||globalThis.mozRTCSessionDescription||globalThis.webkitRTCSessionDescription,RTCIceCandidate:globalThis.RTCIceCandidate||globalThis.mozRTCIceCandidate||globalThis.webkitRTCIceCandidate};return t.RTCPeerConnection?t:null}function u(t,e){return Object.defineProperty(t,"code",{value:e,enumerable:!0,configurable:!0}),t}function ve(t){return t.replace(/a=ice-options:trickle\s\n/g,"")}function tt(t){console.warn(t)}class H{constructor(e={}){if(this._map=new Map,this._id=Pe(4).toString("hex").slice(0,7),this._doDebug=e.debug,this._debug("new peer %o",e),this.channelName=e.initiator?e.channelName||Pe(20).toString("hex"):null,this.initiator=e.initiator||!1,this.channelConfig=e.channelConfig||H.channelConfig,this.channelNegotiated=this.channelConfig.negotiated,this.config=Object.assign({},H.config,e.config),this.offerOptions=e.offerOptions||{},this.answerOptions=e.answerOptions||{},this.sdpTransform=e.sdpTransform||(n=>n),this.streams=e.streams||(e.stream?[e.stream]:[]),this.trickle=e.trickle!==void 0?e.trickle:!0,this.allowHalfTrickle=e.allowHalfTrickle!==void 0?e.allowHalfTrickle:!1,this.iceCompleteTimeout=e.iceCompleteTimeout||Ze,this.destroyed=!1,this.destroying=!1,this._connected=!1,this.remoteAddress=void 0,this.remoteFamily=void 0,this.remotePort=void 0,this.localAddress=void 0,this.localFamily=void 0,this.localPort=void 0,this._wrtc=e.wrtc&&typeof e.wrtc=="object"?e.wrtc:je(),!this._wrtc)throw u(typeof window>"u"?new Error("No WebRTC support: Specify `opts.wrtc` option in this environment"):new Error("No WebRTC support: Not a supported browser"),"ERR_WEBRTC_SUPPORT");this._pcReady=!1,this._channelReady=!1,this._iceComplete=!1,this._iceCompleteTimer=null,this._channel=null,this._pendingCandidates=[],this._isNegotiating=!1,this._firstNegotiation=!0,this._batchedNegotiation=!1,this._queuedNegotiation=!1,this._sendersAwaitingStable=[],this._senderMap=new Map,this._closingInterval=null,this._remoteTracks=[],this._remoteStreams=[],this._chunk=null,this._cb=null,this._interval=null;try{this._pc=new this._wrtc.RTCPeerConnection(this.config)}catch(n){this.destroy(u(n,"ERR_PC_CONSTRUCTOR"));return}this._isReactNativeWebrtc=typeof this._pc._peerConnectionId=="number",this._pc.oniceconnectionstatechange=()=>{this._onIceStateChange()},this._pc.onicegatheringstatechange=()=>{this._onIceStateChange()},this._pc.onconnectionstatechange=()=>{this._onConnectionStateChange()},this._pc.onsignalingstatechange=()=>{this._onSignalingStateChange()},this._pc.onicecandidate=n=>{this._onIceCandidate(n)},typeof this._pc.peerIdentity=="object"&&this._pc.peerIdentity.catch(n=>{this.destroy(u(n,"ERR_PC_PEER_IDENTITY"))}),this.initiator||this.channelNegotiated?this._setupData({channel:this._pc.createDataChannel(this.channelName,this.channelConfig)}):this._pc.ondatachannel=n=>{this._setupData(n)},this.streams&&this.streams.forEach(n=>{this.addStream(n)}),this._pc.ontrack=n=>{this._onTrack(n)},this._debug("initial negotiation"),this._needsNegotiation()}get bufferSize(){return this._channel&&this._channel.bufferedAmount||0}get connected(){return this._connected&&this._channel.readyState==="open"}address(){return{port:this.localPort,family:this.localFamily,address:this.localAddress}}signal(e){if(!this.destroying){if(this.destroyed)throw u(new Error("cannot signal after peer is destroyed"),"ERR_DESTROYED");if(typeof e=="string")try{e=JSON.parse(e)}catch{e={}}this._debug("signal()"),e.renegotiate&&this.initiator&&(this._debug("got request to renegotiate"),this._needsNegotiation()),e.transceiverRequest&&this.initiator&&(this._debug("got request for transceiver"),this.addTransceiver(e.transceiverRequest.kind,e.transceiverRequest.init)),e.candidate&&(this._pc.remoteDescription&&this._pc.remoteDescription.type?this._addIceCandidate(e.candidate):this._pendingCandidates.push(e.candidate)),e.sdp&&this._pc.setRemoteDescription(new this._wrtc.RTCSessionDescription(e)).then(()=>{this.destroyed||(this._pendingCandidates.forEach(n=>{this._addIceCandidate(n)}),this._pendingCandidates=[],this._pc.remoteDescription.type==="offer"&&this._createAnswer())}).catch(n=>{this.destroy(u(n,"ERR_SET_REMOTE_DESCRIPTION"))}),!e.sdp&&!e.candidate&&!e.renegotiate&&!e.transceiverRequest&&this.destroy(u(new Error("signal() called with invalid signal data"),"ERR_SIGNALING"))}}_addIceCandidate(e){const n=new this._wrtc.RTCIceCandidate(e);this._pc.addIceCandidate(n).catch(s=>{!n.address||n.address.endsWith(".local")?tt("Ignoring unsupported ICE candidate."):this.destroy(u(s,"ERR_ADD_ICE_CANDIDATE"))})}send(e){if(!this.destroying){if(this.destroyed)throw u(new Error("cannot send after peer is destroyed"),"ERR_DESTROYED");this._channel.send(e)}}addTransceiver(e,n){if(!this.destroying){if(this.destroyed)throw u(new Error("cannot addTransceiver after peer is destroyed"),"ERR_DESTROYED");if(this._debug("addTransceiver()"),this.initiator)try{this._pc.addTransceiver(e,n),this._needsNegotiation()}catch(s){this.destroy(u(s,"ERR_ADD_TRANSCEIVER"))}else this.emit("signal",{type:"transceiverRequest",transceiverRequest:{kind:e,init:n}})}}addStream(e){if(!this.destroying){if(this.destroyed)throw u(new Error("cannot addStream after peer is destroyed"),"ERR_DESTROYED");this._debug("addStream()"),e.getTracks().forEach(n=>{this.addTrack(n,e)})}}addTrack(e,n){if(this.destroying)return;if(this.destroyed)throw u(new Error("cannot addTrack after peer is destroyed"),"ERR_DESTROYED");this._debug("addTrack()");const s=this._senderMap.get(e)||new Map;let i=s.get(n);if(!i)i=this._pc.addTrack(e,n),s.set(n,i),this._senderMap.set(e,s),this._needsNegotiation();else throw i.removed?u(new Error("Track has been removed. You should enable/disable tracks that you want to re-add."),"ERR_SENDER_REMOVED"):u(new Error("Track has already been added to that stream."),"ERR_SENDER_ALREADY_ADDED")}replaceTrack(e,n,s){if(this.destroying)return;if(this.destroyed)throw u(new Error("cannot replaceTrack after peer is destroyed"),"ERR_DESTROYED");this._debug("replaceTrack()");const i=this._senderMap.get(e),o=i?i.get(s):null;if(!o)throw u(new Error("Cannot replace track that was never added."),"ERR_TRACK_NOT_ADDED");n&&this._senderMap.set(n,i),o.replaceTrack!=null?o.replaceTrack(n):this.destroy(u(new Error("replaceTrack is not supported in this browser"),"ERR_UNSUPPORTED_REPLACETRACK"))}removeTrack(e,n){if(this.destroying)return;if(this.destroyed)throw u(new Error("cannot removeTrack after peer is destroyed"),"ERR_DESTROYED");this._debug("removeSender()");const s=this._senderMap.get(e),i=s?s.get(n):null;if(!i)throw u(new Error("Cannot remove track that was never added."),"ERR_TRACK_NOT_ADDED");try{i.removed=!0,this._pc.removeTrack(i)}catch(o){o.name==="NS_ERROR_UNEXPECTED"?this._sendersAwaitingStable.push(i):this.destroy(u(o,"ERR_REMOVE_TRACK"))}this._needsNegotiation()}removeStream(e){if(!this.destroying){if(this.destroyed)throw u(new Error("cannot removeStream after peer is destroyed"),"ERR_DESTROYED");this._debug("removeSenders()"),e.getTracks().forEach(n=>{this.removeTrack(n,e)})}}_needsNegotiation(){this._debug("_needsNegotiation"),!this._batchedNegotiation&&(this._batchedNegotiation=!0,queueMicrotask(()=>{this._batchedNegotiation=!1,this.initiator||!this._firstNegotiation?(this._debug("starting batched negotiation"),this.negotiate()):this._debug("non-initiator initial negotiation request discarded"),this._firstNegotiation=!1}))}negotiate(){if(!this.destroying){if(this.destroyed)throw u(new Error("cannot negotiate after peer is destroyed"),"ERR_DESTROYED");this.initiator?this._isNegotiating?(this._queuedNegotiation=!0,this._debug("already negotiating, queueing")):(this._debug("start negotiation"),setTimeout(()=>{this._createOffer()},0)):this._isNegotiating?(this._queuedNegotiation=!0,this._debug("already negotiating, queueing")):(this._debug("requesting negotiation from initiator"),this.emit("signal",{type:"renegotiate",renegotiate:!0})),this._isNegotiating=!0}}destroy(e){this.destroyed||this.destroying||(this.destroying=!0,this._debug("destroying (error: %s)",e&&(e.message||e)),queueMicrotask(()=>{if(this.destroyed=!0,this.destroying=!1,this._debug("destroy (error: %s)",e&&(e.message||e)),this._connected=!1,this._pcReady=!1,this._channelReady=!1,this._remoteTracks=null,this._remoteStreams=null,this._senderMap=null,clearInterval(this._closingInterval),this._closingInterval=null,clearInterval(this._interval),this._interval=null,this._chunk=null,this._cb=null,this._channel){try{this._channel.close()}catch{}this._channel.onmessage=null,this._channel.onopen=null,this._channel.onclose=null,this._channel.onerror=null}if(this._pc){try{this._pc.close()}catch{}this._pc.oniceconnectionstatechange=null,this._pc.onicegatheringstatechange=null,this._pc.onsignalingstatechange=null,this._pc.onicecandidate=null,this._pc.ontrack=null,this._pc.ondatachannel=null}this._pc=null,this._channel=null,e&&this.emit("error",e),this.emit("close")}))}_setupData(e){if(!e.channel)return this.destroy(u(new Error("Data channel event is missing `channel` property"),"ERR_DATA_CHANNEL"));this._channel=e.channel,this._channel.binaryType="arraybuffer",typeof this._channel.bufferedAmountLowThreshold=="number"&&(this._channel.bufferedAmountLowThreshold=Ne),this.channelName=this._channel.label,this._channel.onmessage=s=>{this._onChannelMessage(s)},this._channel.onbufferedamountlow=()=>{this._onChannelBufferedAmountLow()},this._channel.onopen=()=>{this._onChannelOpen()},this._channel.onclose=()=>{this._onChannelClose()},this._channel.onerror=s=>{this.destroy(u(s,"ERR_DATA_CHANNEL"))};let n=!1;this._closingInterval=setInterval(()=>{this._channel&&this._channel.readyState==="closing"?(n&&this._onChannelClose(),n=!0):n=!1},et)}_startIceCompleteTimeout(){this.destroyed||this._iceCompleteTimer||(this._debug("started iceComplete timeout"),this._iceCompleteTimer=setTimeout(()=>{this._iceComplete||(this._iceComplete=!0,this._debug("iceComplete timeout completed"),this.emit("iceTimeout"),this.emit("_iceComplete"))},this.iceCompleteTimeout))}_createOffer(){this.destroyed||this._pc.createOffer(this.offerOptions).then(e=>{if(this.destroyed)return;!this.trickle&&!this.allowHalfTrickle&&(e.sdp=ve(e.sdp)),e.sdp=this.sdpTransform(e.sdp);const n=()=>{if(this.destroyed)return;const o=this._pc.localDescription||e;this._debug("signal"),this.emit("signal",{type:o.type,sdp:o.sdp})},s=()=>{this._debug("createOffer success"),!this.destroyed&&(this.trickle||this._iceComplete?n():this.once("_iceComplete",n))},i=o=>{this.destroy(u(o,"ERR_SET_LOCAL_DESCRIPTION"))};this._pc.setLocalDescription(e).then(s).catch(i)}).catch(e=>{this.destroy(u(e,"ERR_CREATE_OFFER"))})}_requestMissingTransceivers(){this._pc.getTransceivers&&this._pc.getTransceivers().forEach(e=>{!e.mid&&e.sender.track&&!e.requested&&(e.requested=!0,this.addTransceiver(e.sender.track.kind))})}_createAnswer(){this.destroyed||this._pc.createAnswer(this.answerOptions).then(e=>{if(this.destroyed)return;!this.trickle&&!this.allowHalfTrickle&&(e.sdp=ve(e.sdp)),e.sdp=this.sdpTransform(e.sdp);const n=()=>{if(this.destroyed)return;const o=this._pc.localDescription||e;this._debug("signal"),this.emit("signal",{type:o.type,sdp:o.sdp}),this.initiator||this._requestMissingTransceivers()},s=()=>{this.destroyed||(this.trickle||this._iceComplete?n():this.once("_iceComplete",n))},i=o=>{this.destroy(u(o,"ERR_SET_LOCAL_DESCRIPTION"))};this._pc.setLocalDescription(e).then(s).catch(i)}).catch(e=>{this.destroy(u(e,"ERR_CREATE_ANSWER"))})}_onConnectionStateChange(){this.destroyed||this._pc.connectionState==="failed"&&this.destroy(u(new Error("Connection failed."),"ERR_CONNECTION_FAILURE"))}_onIceStateChange(){if(this.destroyed)return;const e=this._pc.iceConnectionState,n=this._pc.iceGatheringState;this._debug("iceStateChange (connection: %s) (gathering: %s)",e,n),this.emit("iceStateChange",e,n),(e==="connected"||e==="completed")&&(this._pcReady=!0,this._maybeReady()),e==="failed"&&this.destroy(u(new Error("Ice connection failed."),"ERR_ICE_CONNECTION_FAILURE")),e==="closed"&&this.destroy(u(new Error("Ice connection closed."),"ERR_ICE_CONNECTION_CLOSED"))}getStats(e){const n=s=>(Object.prototype.toString.call(s.values)==="[object Array]"&&s.values.forEach(i=>{Object.assign(s,i)}),s);this._pc.getStats.length===0||this._isReactNativeWebrtc?this._pc.getStats().then(s=>{const i=[];s.forEach(o=>{i.push(n(o))}),e(null,i)},s=>e(s)):this._pc.getStats.length>0?this._pc.getStats(s=>{if(this.destroyed)return;const i=[];s.result().forEach(o=>{const m={};o.names().forEach(P=>{m[P]=o.stat(P)}),m.id=o.id,m.type=o.type,m.timestamp=o.timestamp,i.push(n(m))}),e(null,i)},s=>e(s)):e(null,[])}_maybeReady(){if(this._debug("maybeReady pc %s channel %s",this._pcReady,this._channelReady),this._connected||this._connecting||!this._pcReady||!this._channelReady)return;this._connecting=!0;const e=()=>{this.destroyed||this.getStats((n,s)=>{if(this.destroyed)return;n&&(s=[]);const i={},o={},m={};let P=!1;s.forEach(l=>{(l.type==="remotecandidate"||l.type==="remote-candidate")&&(i[l.id]=l),(l.type==="localcandidate"||l.type==="local-candidate")&&(o[l.id]=l),(l.type==="candidatepair"||l.type==="candidate-pair")&&(m[l.id]=l)});const v=l=>{P=!0;let _=o[l.localCandidateId];_&&(_.ip||_.address)?(this.localAddress=_.ip||_.address,this.localPort=Number(_.port)):_&&_.ipAddress?(this.localAddress=_.ipAddress,this.localPort=Number(_.portNumber)):typeof l.googLocalAddress=="string"&&(_=l.googLocalAddress.split(":"),this.localAddress=_[0],this.localPort=Number(_[1])),this.localAddress&&(this.localFamily=this.localAddress.includes(":")?"IPv6":"IPv4");let y=i[l.remoteCandidateId];y&&(y.ip||y.address)?(this.remoteAddress=y.ip||y.address,this.remotePort=Number(y.port)):y&&y.ipAddress?(this.remoteAddress=y.ipAddress,this.remotePort=Number(y.portNumber)):typeof l.googRemoteAddress=="string"&&(y=l.googRemoteAddress.split(":"),this.remoteAddress=y[0],this.remotePort=Number(y[1])),this.remoteAddress&&(this.remoteFamily=this.remoteAddress.includes(":")?"IPv6":"IPv4"),this._debug("connect local: %s:%s remote: %s:%s",this.localAddress,this.localPort,this.remoteAddress,this.remotePort)};if(s.forEach(l=>{l.type==="transport"&&l.selectedCandidatePairId&&v(m[l.selectedCandidatePairId]),(l.type==="googCandidatePair"&&l.googActiveConnection==="true"||(l.type==="candidatepair"||l.type==="candidate-pair")&&l.selected)&&v(l)}),!P&&(!Object.keys(m).length||Object.keys(o).length)){setTimeout(e,100);return}else this._connecting=!1,this._connected=!0;if(this._chunk){try{this.send(this._chunk)}catch(_){return this.destroy(u(_,"ERR_DATA_CHANNEL"))}this._chunk=null,this._debug('sent chunk from "write before connect"');const l=this._cb;this._cb=null,l(null)}typeof this._channel.bufferedAmountLowThreshold!="number"&&(this._interval=setInterval(()=>this._onInterval(),150),this._interval.unref&&this._interval.unref()),this._debug("connect"),this.emit("connect")})};e()}_onInterval(){!this._cb||!this._channel||this._channel.bufferedAmount>Ne||this._onChannelBufferedAmountLow()}_onSignalingStateChange(){this.destroyed||(this._pc.signalingState==="stable"&&(this._isNegotiating=!1,this._debug("flushing sender queue",this._sendersAwaitingStable),this._sendersAwaitingStable.forEach(e=>{this._pc.removeTrack(e),this._queuedNegotiation=!0}),this._sendersAwaitingStable=[],this._queuedNegotiation?(this._debug("flushing negotiation queue"),this._queuedNegotiation=!1,this._needsNegotiation()):(this._debug("negotiated"),this.emit("negotiated"))),this._debug("signalingStateChange %s",this._pc.signalingState),this.emit("signalingStateChange",this._pc.signalingState))}_onIceCandidate(e){this.destroyed||(e.candidate&&this.trickle?this.emit("signal",{type:"candidate",candidate:{candidate:e.candidate.candidate,sdpMLineIndex:e.candidate.sdpMLineIndex,sdpMid:e.candidate.sdpMid}}):!e.candidate&&!this._iceComplete&&(this._iceComplete=!0,this.emit("_iceComplete")),e.candidate&&this._startIceCompleteTimeout())}_onChannelMessage(e){if(this.destroyed)return;let n=e.data;n instanceof ArrayBuffer&&(n=new Uint8Array(n)),this.emit("data",n)}_onChannelBufferedAmountLow(){if(this.destroyed||!this._cb)return;this._debug("ending backpressure: bufferedAmount %d",this._channel.bufferedAmount);const e=this._cb;this._cb=null,e(null)}_onChannelOpen(){this._connected||this.destroyed||(this._debug("on channel open"),this._channelReady=!0,this._maybeReady())}_onChannelClose(){this.destroyed||(this._debug("on channel close"),this.destroy())}_onTrack(e){this.destroyed||e.streams.forEach(n=>{this._debug("on track"),this.emit("track",e.track,n),this._remoteTracks.push({track:e.track,stream:n}),!this._remoteStreams.some(s=>s.id===n.id)&&(this._remoteStreams.push(n),queueMicrotask(()=>{this._debug("on stream"),this.emit("stream",n)}))})}_debug(...e){!this._doDebug||(e[0]="["+this._id+"] "+e[0],console.log(...e))}on(e,n){const s=this._map;s.has(e)||s.set(e,new Set),s.get(e).add(n)}off(e,n){const s=this._map,i=s.get(e);!i||(i.delete(n),i.size===0&&s.delete(e))}once(e,n){const s=(...i)=>{this.off(e,s),n(...i)};this.on(e,s)}emit(e,...n){const s=this._map;if(!!s.has(e))for(const i of s.get(e))try{i(...n)}catch(o){console.error(o)}}}H.WEBRTC_SUPPORT=!!je();H.config={iceServers:[{urls:["stun:stun.l.google.com:19302","stun:global.stun.twilio.com:3478"]}],sdpSemantics:"unified-plan"};H.channelConfig={};const De="0123456789AaBbCcDdEeFfGgHhIiJjKkLlMmNnOoPpQqRrSsTtUuVvWwXxYyZz",Ie=(t,e,n)=>{const s=new H({initiator:t,trickle:e,config:n}),i=o=>s.__earlyDataBuffer.push(o);return s.on(S.data,i),s.__earlyDataBuffer=[],s.__drainEarlyData=o=>{s.off(S.data,i),s.__earlyDataBuffer.forEach(o),delete s.__earlyDataBuffer,delete s.__drainEarlyData},s},xe=t=>new Array(t).fill().map(()=>De[Math.floor(Math.random()*De.length)]).join(""),nt=(t,e)=>(n,s)=>{if(t[s])throw A(`already joined room ${s}`);if(!n)throw A("requires a config map as the first argument");if(!n.appId&&!n.firebaseApp)throw A("config map is missing appId field");if(!s)throw A("namespace argument required");return e(n,s)},ee="Trystero",ye=xe(20),{keys:Oe,values:st,entries:Te,fromEntries:He}=Object,x=()=>{},A=t=>new Error(`${ee}: ${t}`),F=t=>new TextEncoder().encode(t),X=t=>new TextDecoder().decode(t),S=He(["close","connect","data","error","signal","stream","track"].map(t=>[t,t])),it=t=>{const e=new Uint8Array(t.reduce((n,s)=>n+s.byteLength,0));return t.reduce((n,s)=>(e.set(s,n),n+s.byteLength),0),e},rt=Object.getPrototypeOf(Uint8Array),ue=12,Je=0,fe=Je+ue,_e=fe+1,Q=_e+1,Z=Q+1,j=16*2**10-Z,he=255,Le="bufferedamountlow",ot=(t,e)=>{const n={},s={},i={},o={},m={},P={},v=(r,a)=>(r?Array.isArray(r)?r:[r]:Oe(n)).flatMap(f=>{const d=n[f];return d?a(f,d):(console.warn(`${ee}: no peer with id ${f} found`),[])}),l=r=>{!n[r]||(delete n[r],delete i[r],delete o[r],E(r))},_=r=>{if(!r)throw A("action type argument is required");const a=F(r);if(a.byteLength>ue)throw A(`action type string "${r}" (${a.byteLength}b) exceeds byte limit (${ue}). Hint: choose a shorter name.`);const f=new Uint8Array(ue);f.set(a);const d=X(f);if(s[d])throw A(`action '${r}' already registered`);let b=0;return s[d]={onComplete:x,onProgress:x},[async(p,Y,k,ce)=>{if(k&&typeof k!="object")throw A("action meta argument must be an object");if(p===void 0)throw A("action data cannot be undefined");const de=typeof p!="string",le=p instanceof Blob,G=le||p instanceof ArrayBuffer||p instanceof rt;if(k&&!G)throw A("action meta argument can only be used with binary data");const D=G?new Uint8Array(le?await p.arrayBuffer():p):F(de?JSON.stringify(p):p),z=k?F(JSON.stringify(k)):null,$=Math.ceil(D.byteLength/j)+(k?1:0),Xe=new Array($).fill().map((me,I)=>{const q=I===$-1,B=k&&I===0,O=new Uint8Array(Z+(B?z.byteLength:q?D.byteLength-j*($-(k?2:1)):j));return O.set(f),O.set([b],fe),O.set([q|B<<1|G<<2|de<<3],_e),O.set([Math.round((I+1)/$*he)],Q),O.set(k?B?z:D.subarray((I-1)*j,I*j):D.subarray(I*j,(I+1)*j),Z),O});return b=b+1&he,Promise.all(v(Y,async(me,I)=>{const q=I._channel;let B=0;for(;B<$;){const O=Xe[B];if(q.bufferedAmount>q.bufferedAmountLowThreshold&&await new Promise(Qe=>{const Ae=()=>{q.removeEventListener(Le,Ae),Qe()};q.addEventListener(Le,Ae)}),!n[me])break;I.send(O),B++,ce&&ce(O[Q]/he,me,k)}}))},p=>s[d]={...s[d],onComplete:p},p=>s[d]={...s[d],onProgress:p}]},y=(r,a)=>{const f=new Uint8Array(a),d=X(f.subarray(Je,fe)),[b]=f.subarray(fe,_e),[p]=f.subarray(_e,Q),[Y]=f.subarray(Q,Z),k=f.subarray(Z),ce=!!(p&1),de=!!(p&1<<1),le=!!(p&1<<2),G=!!(p&1<<3);if(!s[d])throw A(`received message with unregistered type (${d})`);i[r]||(i[r]={}),i[r][d]||(i[r][d]={});let D=i[r][d][b];if(D||(D=i[r][d][b]={chunks:[]}),de?D.meta=JSON.parse(X(k)):D.chunks.push(k),s[d].onProgress(Y/he,r,D.meta),!ce)return;const z=it(D.chunks);if(le)s[d].onComplete(z,r,D.meta);else{const $=X(z);s[d].onComplete(G?JSON.parse($):$,r)}delete i[r][d][b]},[re,oe]=_("__91n6__"),[J,V]=_("__90n6__"),[ae,M]=_("__516n4L__"),[U,h]=_("__57r34m__"),[g,T]=_("__7r4ck__");let c=x,E=x,C=x,R=x;return t((r,a)=>{if(n[a])return;const f=y.bind(null,a);n[a]=r,r.on(S.signal,d=>ae(d,a)),r.on(S.close,()=>l(a)),r.on(S.data,f),r.on(S.stream,d=>{C(d,a,m[a]),delete m[a]}),r.on(S.track,(d,b)=>{R(d,b,a,P[a]),delete P[a]}),r.on(S.error,d=>{d.code!=="ERR_DATA_CHANNEL"&&console.error(d)}),c(a),r.__drainEarlyData(f)}),oe((r,a)=>J(null,a)),V((r,a)=>{o[a]&&(o[a](),delete o[a])}),M((r,a)=>{n[a]&&n[a].signal(r)}),h((r,a)=>m[a]=r),T((r,a)=>P[a]=r),{makeAction:_,ping:async r=>{if(!r)throw A("ping() must be called with target peer ID");const a=Date.now();return re(null,r),await new Promise(f=>o[r]=f),Date.now()-a},leave:()=>{Te(n).forEach(([r,a])=>{a.destroy(),delete n[r]}),e()},getPeers:()=>Oe(n),addStream:(r,a,f)=>v(a,async(d,b)=>{f&&await U(f,d),b.addStream(r)}),removeStream:(r,a)=>v(a,(f,d)=>d.removeStream(r)),addTrack:(r,a,f,d)=>v(f,async(b,p)=>{d&&await g(d,b),p.addTrack(r,a)}),removeTrack:(r,a,f)=>v(f,(d,b)=>b.removeTrack(r,a)),replaceTrack:(r,a,f,d,b)=>v(d,async(p,Y)=>{b&&await g(b,p),Y.replaceTrack(r,a,f)}),onPeerJoin:r=>c=r,onPeerLeave:r=>E=r,onPeerStream:r=>C=r,onPeerTrack:r=>R=r}},Ee="AES-CBC",at=t=>window.btoa(String.fromCharCode.apply(null,new Uint8Array(t))),ct=t=>{const e=window.atob(t);return new Uint8Array(e.length).map((n,s)=>e.charCodeAt(s)).buffer},dt=async(t,e)=>crypto.subtle.importKey("raw",await crypto.subtle.digest({name:"SHA-256"},F(`${t}:${e}`)),{name:Ee},!1,["encrypt","decrypt"]),Me=async(t,e)=>{const n=crypto.getRandomValues(new Uint8Array(16));return JSON.stringify({c:at(await crypto.subtle.encrypt({name:Ee,iv:n},await t,F(e))),iv:[...n]})},$e=async(t,e)=>{const{c:n,iv:s}=JSON.parse(e);return X(await crypto.subtle.decrypt({name:Ee,iv:new Uint8Array(s)},await t,ct(n)))},be={},we={},K={},Ue=20,qe=10,lt=2,ht=33,ut=120,Be="announce",ft=["wss://tracker.openwebtorrent.com","wss://tracker.btorrent.xyz","wss://tracker.files.fm:7073/announce","wss://qot.abiir.top:443/announce","wss://spacetradersapi-chatbox.herokuapp.com:443/announce"],_t=nt(be,(t,e)=>{const n={},s=t.password&&dt(t.password,e),i=(t.trackerUrls||ft).slice(0,t.trackerUrls?t.trackerUrls.length:t.trackerRedundancy||lt);if(!i.length)throw A("trackerUrls is empty");const o=crypto.subtle.digest("SHA-1",F(`${ee}:${t.appId}:${e}`)).then(h=>Array.from(new Uint8Array(h)).map(g=>g.toString(36)).join("").slice(0,Ue)),m=()=>He(new Array(qe).fill().map(()=>{const h=Ie(!0,!1,t.rtcConfig);return[xe(Ue),{peer:h,offerP:new Promise(g=>h.once(S.signal,g))}]})),P=async(h,g)=>{const T=await o;let c;try{c=JSON.parse(g.data)}catch{console.error(`${ee}: received malformed SDP JSON`);return}if(c.info_hash!==T||c.peer_id&&c.peer_id===ye)return;const E=c["failure reason"];if(E){console.warn(`${ee}: torrent tracker failure (${E})`);return}if(c.interval&&c.interval>J&&c.interval<=ut&&(clearInterval(V),J=c.interval,V=setInterval(_,J*1e3)),c.offer&&c.offer_id){if(n[c.peer_id]||M[c.offer_id])return;M[c.offer_id]=!0;const C=Ie(!1,!1,t.rtcConfig);C.once(S.signal,async R=>h.send(JSON.stringify({answer:s?{...R,sdp:await Me(s,R.sdp)}:R,action:Be,info_hash:T,peer_id:ye,to_peer_id:c.peer_id,offer_id:c.offer_id}))),C.on(S.connect,()=>re(C,c.peer_id)),C.on(S.close,()=>oe(c.peer_id)),C.signal(s?{...c.offer,sdp:await $e(s,c.offer.sdp)}:c.offer);return}if(c.answer){if(n[c.peer_id]||M[c.offer_id])return;const C=U[c.offer_id];if(C){const{peer:R}=C;if(R.destroyed)return;M[c.offer_id]=!0,R.on(S.connect,()=>re(R,c.peer_id,c.offer_id)),R.on(S.close,()=>oe(c.peer_id)),R.signal(s?{...c.answer,sdp:await $e(s,c.answer.sdp)}:c.answer)}}},v=async(h,g)=>h.send(JSON.stringify({action:Be,info_hash:g,numwant:qe,peer_id:ye,offers:await Promise.all(Te(U).map(async([T,{offerP:c}])=>{const E=await c;return{offer_id:T,offer:s?{...E,sdp:await Me(s,E.sdp)}:E}}))})),l=(h,g,T)=>(T||!we[h]?(K[h]={...K[h],[g]:P},we[h]=new Promise(c=>{const E=new WebSocket(h);E.onopen=c.bind(null,E),E.onmessage=C=>st(K[h]).forEach(R=>R(E,C))})):K[h][g]=P,we[h]),_=async()=>{const h=await o;U&&y(),U=m(),i.forEach(async g=>{const T=await l(g,h);T.readyState===WebSocket.OPEN?v(T,h):T.readyState!==WebSocket.CONNECTING&&v(await l(g,h,!0),h)})},y=()=>{Te(U).forEach(([h,{peer:g}])=>{!M[h]&&!n[h]&&g.destroy()}),M={}},re=(h,g,T)=>{ae(h,g),n[g]=!0,T&&(n[T]=!0)},oe=h=>delete n[h];let J=ht,V=setInterval(_,J*1e3),ae=x,M={},U;return be[e]=!0,_(),ot(h=>ae=h,async()=>{const h=await o;i.forEach(g=>delete K[g][h]),delete be[e],clearInterval(V),y()})});function gt(t){const e=Toastify({text:`${t} (Click to dismiss)`,duration:-1,style:{background:"#dc143c"},onClick:()=>e.hideToast()}).showToast()}function Fe(t){const e=Toastify({text:t,duration:5e3,style:{background:"#ffa500"},onClick:()=>e.hideToast()}).showToast()}function W(t){Toastify({text:t,close:!1,duration:5e3}).showToast()}let te=new URLSearchParams(window.location.search),ne=te.get("username")||localStorage.username||"Guest",ge=te.get("roomId");te.get("host");ge||(ge=(Math.random()+1).toString(36).substring(7),te.set("roomId",ge),window.location.search=te.toString());const N={};ie();const pt={appId:"syncwatch"},se=_t(pt,ge),[Ce,mt]=se.makeAction("name");Ce(ne);mt(bt);let We=[];function yt(t){We.push(t)}yt(t=>{console.log(`Peer joined, id: ${t}`),Ce(ne,t),N[t]=null,ie()});se.onPeerJoin(t=>{We.forEach(e=>e(t))});se.onPeerLeave(t=>{console.log(`Peer left, id: ${t} name: ${N[t]}`),Fe(`${N[t]} left`),delete N[t],ie()});function ie(){let t=document.getElementById("users");t.innerHTML="",t.innerHTML+=`${ne} <br>`;for(const e in N)t.innerHTML+=`${N[e]} <br>`}function bt(t,e){console.log(`Peer updated name, id: ${e} name: ${t}`),N[e]?W(`${N[e]} renamed to ${t}`):W(`${t} joined`),N[e]=t,ie()}function wt(t){ne=localStorage.username=t,Ce(t),ie()}document.getElementById("rename").onclick=function(){let t=prompt("Username:",ne);t!=null&&wt(t)};const Re=new WebTorrent({dht:!1}),Ve=document.getElementById("send-file-input");Ve.addEventListener("change",Tt);function Tt(){const t=Ve.files[0],e=URL.createObjectURL(t);pe(e),console.log(`Preparing to seed ${t.name}`),W(`Preparing to seed ${t.name}`),Re.seed(t,{private:!0},n);function n(s){console.log("seeding:",s.magnetURI),Ke(s.magnetURI),Nt(s.magnetURI)}}function Ye(t,e){!e||!t||(W(`${N[e]} sending file`),Re.add(t,function(n){const s=n.files[0];s.getStreamURL((i,o)=>{pe(o)}),n.on("download",function(i){document.getElementById("download-progress").innerHTML=`Downloading: ${s.name}<br>Speed: ${(n.downloadSpeed/Math.pow(10,6)).toFixed(2)} MB/s<br>Progress: ${(n.progress*100).toFixed(1)}%
`}),n.on("done",function(){n.files.forEach(function(i){document.getElementById("download-progress").innerHTML=`Download Complete: ${i.name}`})})}))}navigator.serviceWorker.register("sw.min.js").then(t=>{const e=t.active||t.waiting||t.installing;function n(s){return s.state==="activated"&&Re.loadWorker(s,Ye)}n(e)||e.addEventListener("statechange",({target:s})=>n(s))});document.getElementById("send-file").onclick=function(){document.getElementById("send-file-input").click()};let w=videojs("my-video",{techOrder:["html5","youtube"]});w.on("ready",()=>{console.log("ready",w.currentSrc())});w.on("loadeddata",()=>{console.log("loadeddata",w.currentSrc())});let Et=["play","pause","seeked"];function Ct(t){const e=ze();e.eventType=t,console.log(t,"event:",JSON.stringify(e)),kt(e,L)||(L=e,Ge(e))}function Rt(){document.getElementById("my-video").addEventListener("click",()=>{Et.forEach(t=>{w.on(t,()=>{Ct(t)})})},{once:!0})}Rt();setInterval(function(){if(L.currentTime!==-1){const t=L.isPaused?0:(Date.now()-L.epoch)/1e3,e=(w.currentTime()-L.currentTime-t).toFixed(2);Math.abs(e)>Se&&(console.log(`desync: ${t} adjustment, ${e} diff`),w.currentTime(w.currentTime()-e),console.log(`Corrected ${-e} seconds desync`),W(`Corrected ${-e} seconds desync`))}},2e3);const[Ge,St]=se.makeAction("videoState");let L={isPaused:!0,currentTime:-1,epoch:0,source:""};const Se=.5;St((t,e)=>{if(L.epoch>t.epoch)return;if(console.log(`${N[e]} (${e}) sent video state ${JSON.stringify(t)}`),w.paused()!=t.isPaused&&(t.isPaused?w.pause():w.play().catch(o=>At(o))),Math.abs(t.currentTime-w.currentTime())>Se){const o=t.isPaused?0:(Date.now()-t.epoch)/1e3;w.currentTime(t.currentTime+o)}L=t;const n=N[e],s=new Date(t.currentTime*1e3).toISOString().substr(11,8),i={play:`${n} started playback at ${s}`,pause:`${n} paused playback at ${s}`,seeked:`${n} seeked to ${s}`};i[t.eventType]&&W(i[t.eventType]),t.cantPlay&&Fe(`${n} cant play`)});function kt(t,e){const n=Math.abs(t.currentTime-e.currentTime)<Se,s=t.isPaused==e.isPaused;return n&&s}function At(t){const e=ze();e.cantPlay=!0,Ge(e),gt(t)}function ze(){return{currentTime:w.currentTime(),isPaused:w.paused(),epoch:Date.now()}}let ke=null;function Nt(t){ke=t}const[Ke,Pt]=se.makeAction("videoSource");Pt((t,e)=>{console.log(`${N[e]} (${e}) sent video source ${t}`),ke=t,t.startsWith("magnet:?")?Ye(t,e):pe(t)});function pe(t){L={isPaused:!0,currentTime:-1,epoch:0,source:t};let e=t.includes("youtube")?"video/youtube":"video/mp4";w.src({type:e,src:t}),w.pause()}document.getElementById("source-url").onclick=function(){let t=prompt("Source URL:",ke);t!=null&&(pe(t),Ke(t))};
